<html>
<head>
<link rel="stylesheet" href="style.css">
<title>Back to the Future - Radio</title>
<style type="text/css">
/* https://codepen.io/KristopherVanSant/pen/dXdVJY */
@font-face {
  font-family: 'lcd';
  src: url('alarm-clock.ttf') format('truetype');
}
@font-face {
  font-family: 'dymo';
  src: url('microgramma.ttf') format('truetype');
e}
@font-face {
  font-family: 'dymo-bold';
  src: url('microgramma-bold.otf') format('opentype');
e}
body {
  filter: blur(0.5px);
  cursor: default;
  user-select: none;
}
#overlay {
  opacity: 0;
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
  background: black;
  z-index: 1;
}
#overlay.white {
  background: white;
}
#tfc {
  cursor: pointer;
}
.container {
  width: 640px;
  font-family: 'lcd', sans-serif;
}
.label, .large-label {
  font-family: dymo;
  padding: 0 2px 0 2px;
  font-size: 14px;
  opacity: 0.75;
  letter-spacing: 1px;
}
.large-label {
  font-family: dymo-bold;
  width: 40%;
}
.box3 .large-label {
  width: 45%;
}
.display {
  /*text-shadow: 0 -2px 3px;*/
  text-shadow: 0 0 10px;
  padding-left: 4px;
  letter-spacing: 0;
  font-size: 48px;
}
.faded-eights {
  position: relative;
  top: -105px;
  left: 2px;
  opacity: 0.2;
  background: 0 none;
  border: 0 none;
}
.time {
  margin-top: 332%;
  margin-bottom: -263%;
}
.lit, .unlit {
  border-top: 1px solid white;
}
.lit {
  background: #f1ac17;
  box-shadow: 0px 0px 3px yellow;
}
.green .lit {
  background: #4cd338;
  box-shadow: 0px 0px 3px #4cd338;
}
</style>
<script type="text/javascript">
// Dynamic date/time.
var time = setInterval(function() {
  var now = new Date();
  const dateArray = [
    now.getFullYear(),    // Year
    now.toLocaleString('en-US', { month: 'short' }),
    //now.getMonth() + 1,   // Month (1–12)
    now.getDate(),        // Day of the month
    now.getHours(),       // Hour (0–23)
    now.getMinutes()      // Minute (0–59)
  ];

  var minute = document.querySelector('.now-min');
  minute.innerHTML = String(dateArray[4]).padStart(2, '0');
  var hour = document.querySelector('.now-hour');
  var hours = dateArray[3];
  const ampm = hours >= 12 ? 'PM' : 'AM';
  var am = document.querySelector('.now-am');
  var pm = document.querySelector('.now-pm');
  if (ampm == 'AM') {
    am.classList.add('lit');
    am.classList.remove('unlit');
    pm.classList.add('unlit');
    pm.classList.remove('lit');
  }
  else {
    pm.classList.add('lit');
    pm.classList.remove('unlit');
    am.classList.add('unlit');
    am.classList.remove('lit');
  }
  hours = hours % 12;
  hours = hours ? hours : 12; // Handle midnight (0 hours → 12)
  hour.innerHTML = String(hours).padStart(2, '0');
  var year = document.querySelector('.now-year');
  year.innerHTML = dateArray[0];
  var day = document.querySelector('.now-day');
  day.innerHTML = String(dateArray[2]).padStart(2, '0');
  var month = document.querySelector('.now-month');
  month.innerHTML = dateArray[1];

  // Blinking dots.
  var colon = document.querySelectorAll('.time');
  for (var dot of colon) {
    if (dot.classList.contains('lit')) {
      dot.classList.remove('lit');
      dot.classList.add('unlit');
    }
    else {
      dot.classList.remove('unlit');
      dot.classList.add('lit');
    }
  }
}, 500);

var queue = [];
const audioEnded = function() {
  if (player.src.includes("delorean")) {
    flashFromWhite(100);
  }
  if (queue.length > 0) {
    var url = queue.shift();
    player.src = url;
    player.play();
    if (url.includes("thunder")) {
      flashBlack(100);
    }
    if (url.includes("lighting")) {
      flashFromWhite(10);
    }
    if (url.includes("sparkInterrupt")) {
      //flashFromWhite(100);
      flashToWhite(50);
    }
    if (url.includes("reentry")) {
      //flashBlack(100);
      urls.forEach(item => queue.push(item));
    }
    if (url.includes("delorean")) {
      flashFromWhite(30000);
    }
  }
};

var urls = [];
const getNextSongs = async function(year) {
  // const response = await fetch('https://alt.dysproseum.com:4443/?y=' + year);
  const port = 4443;
  const url = window.location.protocol + '//' + window.location.hostname + ':' + port;
  const response = await fetch(url + '?y=' + year);
  for await (const chunk of response.body) {
    // Process chunk (e.g., decode and accumulate)
    const text = new TextDecoder().decode(chunk, { stream: true });
    console.log(text);
    urls.push(text.replace('http', 'https'));
  }
};

var timer;
const fadeInWhite = function() {
  var y = overlay.style.opacity;
  if (y == 0) {
    clearTimeout(timer);
    overlay.classList.remove("white");
  }
  y -= 0.01;
  overlay.style.opacity = y;
};
const fadeOutWhite = function() {
  var y = parseFloat(overlay.style.opacity);
  if (y == 1) {
    clearTimeout(timer);
  }
  y += 0.01;
  overlay.style.opacity = y;
};
const flashToWhite = function(step) {
  clearTimeout(timer);
  overlay.classList.add("white");
  overlay.style.opacity = 0;
  timer = setInterval(fadeOutWhite, step);
}
const flashFromWhite = function(step) {
  clearTimeout(timer);
  overlay.classList.add("white");
  overlay.style.opacity = 1;
  timer = setInterval(fadeInWhite, step);
}

const fadeBlack = function() {
  var y = overlay.style.opacity;
  if (y == 0) {
    clearTimeout(timer);
  }
  y -= 0.01;
  overlay.style.opacity = y;
};
const flashBlack = function(step) {
  clearTimeout(timer);
  overlay.classList.remove("white");
  overlay.style.opacity = 1;
  timer = setInterval(fadeBlack, step);
}

// Load.
window.addEventListener("load", function() {
  player.volume = 0.5;
  player.addEventListener("ended", audioEnded);

  // time circuits on
  tfc.addEventListener("click", function() {
    // play sound
    player.src = 'assets/general/timeCircuits/tfcOn.wav';
    player.play();
    // enable all displays except month
    var x = document.querySelectorAll(".display");

    // fade in months top to bottom
  });

  // typing digits alters top row
  var counter = 0;
  var timer;
  var tmp;
  document.addEventListener("keypress", function(e) {
    e.preventDefault();

    var month = document.querySelector('.then-month');
    var day = document.querySelector('.then-day');
    var year = document.querySelector('.then-year');

    if (e.code == "Enter") {
      // Get next song(s).
      var y = parseInt(year.innerHTML);
      queue = [];
      urls = [];
      getNextSongs(y);

      // Time travel effects:
      queue.push('assets/general/timeCircuits/tfcEnter.wav');
      queue.push('assets/general/timeCircuits/SID.wav');
      // black
      queue.push('assets/general/speedoTick.wav');
      queue.push('assets/general/speedoTick.wav');
      queue.push('assets/general/speedoTick.wav');
      queue.push('assets/general/thunder.wav');
      // black
      overlay.style.display = "block";
      //   lightningStrike
      queue.push('assets/bttf2/timeTravel/lightingStrike.wav');
      // flash white
      //   sparks, sparkInterrupt
      // queue.push('assets/bttf1/timeTravel/sparks.wav');
      queue.push('assets/general/timeTravel/sparkInterrupt.wav');
      // white clouds?
      //   beep, beep, beep, warning
      queue.push('assets/general/timeCircuits/beep.wav');
      queue.push('assets/general/timeCircuits/beep.wav');
      queue.push('assets/general/timeCircuits/beep.wav');
      queue.push('assets/general/timeCircuits/beep.wav');
      queue.push('assets/general/rc/warning.wav');
      queue.push('assets/bttf1/timeTravel/reentry.wav');
      // @todo update times
      // present => last time departed
      // destination => present
      // destination => ?
      queue.push('assets/general/delorean%20fart.wav');
      // fade back in
      player.play();

      // manually queue songs
      // if (y > 1920 && y < 1930) {
      //   queue.push('smb://server/share/' + y + '.mp3');
      // }
      // else if (y > 1960 && y < 1970) {
      //   queue.push('assets/' + y + '.mp3');
      // }

      return;
    }

    if (e.code == "Space") {
      player.src = 'assets/general/horn.wav';
      player.play();
      return;
    }

    if (!isFinite(e.key)) {
      return;
    }

    // setTimeout wait for 8 keys
    clearTimeout(timer);
    timer = setTimeout(function() {
      counter = 0;
    }, 3000);

    // shift
    if (counter == 0) {
      tmp = [
        '&nbsp;',
        '&nbsp;',
        '&nbsp;',
        '&nbsp;',
        '&nbsp;',
        '&nbsp;',
        '&nbsp;',
        '&nbsp;',
      ];
    }
    tmp[counter] = e.key;

    if (counter == 1) {
      var m = tmp.slice(0, 2).join('');
      var date = new Date('1985-' + m + '-01T00:00:00');
      if (date == "Invalid Date") {
        // play bttf/general/timeCircuits/tfcError.wav
        player.src = 'assets/general/timeCircuits/tfcError.wav';
        player.play();
        counter = 0;
        return;
      }
      var out = date.toLocaleString('en-US', { month: 'short' });
      month.innerHTML = out;
    }
    else if (counter == 3) {
      console.log(tmp);
      var m = tmp.slice(0, 2).join('');
      var d = tmp.slice(2, 4).join('');
      var date = new Date('1985-' + m + '-' + d + 'T00:00:00');
      console.log(date);
      if (date == "Invalid Date") {
        // play error
        player.src = 'assets/general/timeCircuits/tfcError.wav';
        player.play();
        counter = 0;
        return;
      }
      day.innerHTML = d;
    }
    else if (counter == 7) {
      var m = tmp.slice(0, 2).join('');
      var d = tmp.slice(2, 4).join('');
      var y = tmp.slice(4, 8).join('');
      year.innerHTML = y;
    }

    // play bttf/general/keypad sound
    player.src = 'assets/general/keypad/' + e.key + '.wav';
    player.play();

    // count keys
    console.log({counter});
    counter++;
    if (counter > 7) {
      counter = 0;
    }
  });

  // ready radio
    // switch through static?
});
</script>
</head>
<body>
<div id="overlay"></div>
<div class="container">
  <div class="spacer"></div>
  <div class="box box1">
    <div class="wrapper">
      <p class="label">Month</p>
      <p class="display then-month">Feb</p>
      <p class="display faded-eights">888</p>
    </div>
    <div class="wrapper">
      <p class="label">Day</p>
      <p class="display then-day">02</p>
      <p class="display faded-eights">88</p>
    </div>
    <div class="wrapper padding">
      <p class="label">Year</p>
      <p class="display then-year">1993</p>
      <p class="display faded-eights">8888</p>
    </div>
    <div class="wrapper padding">
      <p class="label">Am</p>
      <p class="lit"></p>
      <p class="label">Pm</p>
      <p class="unlit"></p>
    </div>
    <div class="wrapper padding">
      <p class="label">Hour</p>
      <p class="display">05</p>
      <p class="display faded-eights">88</p>
    </div>
    <div class="wrapper padding">
      <p class="lit time"></p>
      <p class="lit time"></p>
    </div>
    <div class="wrapper padding">
      <p class="label">Min</p>
      <p class="display">59</p>
      <p class="display faded-eights">88</p>
    </div>
    <p class="large-label">Destination Time</p>
  </div>
  <div class="box box2">
     <div class="wrapper">
      <p class="label">Month</p>
      <p class="display now-month">Oct</p>
      <p class="display faded-eights">888</p>
    </div>
    <div class="wrapper">
      <p class="label">Day</p>
      <p class="display now-day">26</p>
      <p class="display faded-eights">88</p>
    </div>
    <div class="wrapper padding">
      <p class="label">Year</p>
      <p class="display now-year">2015</p>
      <p class="display faded-eights">8888</p>
    </div>
    <div class="wrapper padding green">
      <p class="label">Am</p>
      <p class="lit now-am"></p>
      <p class="label">Pm</p>
      <p class="unlit now-pm"></p>
    </div>
    <div class="wrapper padding">
      <p class="label">Hour</p>
      <p class="display now-hour">01</p>
      <p class="display faded-eights">88</p>
    </div>
    <div class="wrapper padding green">
      <p class="lit time"></p>
      <p class="lit time"></p>
    </div>
    <div class="wrapper padding">
      <p class="label">Min</p>
      <p class="display now-min">22</p>
      <p class="display faded-eights">88</p>
    </div>
    <p class="large-label">Present Time</p>
  </div>
  <div class="box box3">
     <div class="wrapper">
      <p class="label">Month</p>
      <p class="display">Oct</p>
      <p class="display faded-eights">888</p>
    </div>
    <div class="wrapper">
      <p class="label">Day</p>
      <p class="display">26</p>
      <p class="display faded-eights">88</p>
    </div>
    <div class="wrapper padding">
      <p class="label">Year</p>
      <p class="display">1985</p>
      <p class="display faded-eights">8888</p>
    </div>
    <div class="wrapper padding">
      <p class="label">Am</p>
      <p class="lit"></p>
      <p class="label">Pm</p>
      <p class="unlit"></p>
    </div>
    <div class="wrapper padding">
      <p class="label">Hour</p>
      <p class="display">01</p>
      <p class="display faded-eights">88</p>
    </div>
    <div class="wrapper padding">
      <p class="lit time"></p>
      <p class="lit time"></p>
    </div>
    <div class="wrapper padding">
      <p class="label">Min</p>
      <p class="display">20</p>
      <p class="display faded-eights">88</p>
    </div>
    <p class="large-label">Last Time Departed</p>
  </div>
  <div class="wrapper4">
    <p></p>
    <p class="large-label" id="tfc">Time Circuits</p>
    <p class="large-label" id="alarm">Alarm Clock</p>
    <p></p>
  </div>
  <audio id="player" nocontrols hidden>
</div>
</body>
</html>
